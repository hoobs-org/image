#!/bin/bash

COUNT=0

version() {
    case $1 in
        edge )
            echo "$(./publish released edge)"
            ;;

        stable )
            echo "$(./publish released stable)"
            ;;

        nodesource )
            echo `node -e 'console.log(require("./package.json").engines.nodesource)'`
            ;;

        node )
            echo `node -e 'console.log(require("./package.json").engines.node)'`
            ;;

        * )
            echo `node -e 'console.log(require("./package.json").version)'`
            ;;
    esac
}

image() {
    if [[ $COUNT -gt 0 ]] ; then
        echo "" >> build.log
    fi

    echo "$1 - $2 - $(date)" >> build.log
    echo "------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------" >> build.log

    make $1-version-$2.img.xz.sha256

    echo "------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------" >> build.log

    COUNT=$((COUNT+1))
}

build() {
    touch build.log
    truncate -s 0 build.log

    case $1 in
        vendor )
            make hoobs-vendor
            ;;

        package )
            if [[ "$OSTYPE" == "darwin"* ]]; then
                (cd ../ && ./project pull)

                printf "\033[0;36mBuild package\033[0m\n"
                make hoobs-package
                make clean
            fi

            ;;

        box )
            image "hoobs-box" "armhf"
            ;;

        card )
            image "hoobs" "arm64"
            ;;

        legacy )
            image "hoobs" "armhf"
            ;;

        * )
            image "hoobs-box" "armhf"
            image "hoobs" "arm64"
            image "hoobs" "armhf"
            ;;
    esac
}

rebuild() {
    make clean
    build
}

publish() {
    current=$(version)

    case $1 in
        stable | edge | bleeding )
            reprepro -b ../repo/debian includedeb $1 builds/hbs-vendor-$current-hoobs-all.deb
            ;;
    esac
}

case $1 in
    version )
        shift

        version $@
        ;;

    build )
        shift

        build $@
        ;;

    rebuild )
        rebuild
        ;;

    publish )
        shift

        case $1 in
            vendor )
                shift

                publish $@
                ;;

            * )
                gh auth login
                ./publish $@
                ;;
        esac

        ;;

    clean )
        make clean
        ;;
esac
